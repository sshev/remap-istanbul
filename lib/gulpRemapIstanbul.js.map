{"version":3,"sources":["../src/gulpRemapIstanbul.js"],"names":["remap","require","writeReport","MemoryStore","PluginError","through","module","exports","opts","obj","file","enc","cb","warn","message","fail","console","error","sources","isNull","isStream","collector","JSON","parse","contents","toString","map","length","p","reports","forEach","key","push","reportOpts","Buffer","getFinalCoverage","all","then"],"mappings":";;;;;;;;;;;;;;;;AAAA;AACA;AACA,IAAMA,QAAQC,QAAQ,SAAR,CAAd;AACA,IAAMC,cAAcD,QAAQ,eAAR,CAApB;AACA,IAAME,cAAcF,QAAQ,2BAAR,CAApB;;eACwBA,QAAQ,WAAR,C;IAAhBG,W,YAAAA,W;;AACR,IAAMC,UAAUJ,QAAQ,UAAR,CAAhB;;AAEA;;AAEAK,OAAOC,OAAP,GAAiB,YAAqB;AAAA,KAAXC,IAAW,uEAAJ,EAAI;;AACrC,QAAOH,QAAQI,GAAR,CAAY,UAACC,IAAD,EAAOC,GAAP,EAAYC,EAAZ,EAAmB;AACrC,MAAI,CAACJ,KAAKK,IAAV,EAAgB;AACfL,QAAKK,IAAL,GAAY,UAACC,OAAD,EAAa;AACxB,QAAIN,KAAKO,IAAT,EAAe;AACdH,QAAG,IAAIR,WAAJ,CAAgB,gBAAhB,EAAkCU,OAAlC,CAAH;AACA,KAFD,MAEO;AACNE,aAAQC,KAAR,CAAcH,OAAd;AACA;AACD,IAND;AAOA;;AAEDN,OAAKU,OAAL,GAAe,IAAIf,WAAJ,EAAf;;AAEA,MAAIO,KAAKS,MAAL,EAAJ,EAAmB;AAClBP,MAAG,IAAH,EAASF,IAAT;AACA;;AAED,MAAIA,KAAKU,QAAL,EAAJ,EAAqB;AACpBR,MAAG,IAAIR,WAAJ,CAAgB,gBAAhB,EAAkC,yBAAlC,CAAH;AACA;;AAED,MAAMiB,YAAYrB,MAAMsB,KAAKC,KAAL,CAAWb,KAAKc,QAAL,CAAcC,QAAd,CAAuB,MAAvB,CAAX,CAAN,EAAkDjB,IAAlD,CAAlB;;AAEA,MAAIU,gBAAJ;AACA,MAAI,oBAAYV,KAAKU,OAAL,CAAaQ,GAAzB,EAA8BC,MAAlC,EAA0C;AACzCT,aAAUV,KAAKU,OAAf;AACA;;AAED,MAAMU,IAAI,EAAV;AACA,MAAIpB,KAAKqB,OAAT,EAAkB;AACjB,uBAAYrB,KAAKqB,OAAjB,EAA0BC,OAA1B,CAAkC,UAACC,GAAD,EAAS;AAC1CH,MAAEI,IAAF,CAAO9B,YAAYmB,SAAZ,EAAuBU,GAAvB,EAA4BvB,KAAKyB,UAAL,IAAmB,EAA/C,EAAmDzB,KAAKqB,OAAL,CAAaE,GAAb,CAAnD,EAAsEb,OAAtE,CAAP;AACA,IAFD;AAGA;;AAEDR,OAAKc,QAAL,GAAgB,IAAIU,MAAJ,CAAW,yBAAeb,UAAUc,gBAAV,EAAf,CAAX,CAAhB;;AAEA,oBAAQC,GAAR,CAAYR,CAAZ,EAAeS,IAAf,CAAoB,YAAM;AACzBzB,MAAG,IAAH,EAASF,IAAT;AACA,GAFD;AAGA,EAxCM,CAAP;AAyCA,CA1CD","file":"gulpRemapIstanbul.js","sourcesContent":["/* jshint node: true */\n/* jshint -W079 */\nconst remap = require('./remap');\nconst writeReport = require('./writeReport');\nconst MemoryStore = require('istanbul/lib/store/memory');\nconst { PluginError } = require('gulp-util');\nconst through = require('through2');\n\n/* global Promise */\n\nmodule.exports = function (opts = {}) {\n\treturn through.obj((file, enc, cb) => {\n\t\tif (!opts.warn) {\n\t\t\topts.warn = (message) => {\n\t\t\t\tif (opts.fail) {\n\t\t\t\t\tcb(new PluginError('remap-istanbul', message));\n\t\t\t\t} else {\n\t\t\t\t\tconsole.error(message);\n\t\t\t\t}\n\t\t\t};\n\t\t}\n\n\t\topts.sources = new MemoryStore();\n\n\t\tif (file.isNull()) {\n\t\t\tcb(null, file);\n\t\t}\n\n\t\tif (file.isStream()) {\n\t\t\tcb(new PluginError('remap-istanbul', 'Streaming not supported'));\n\t\t}\n\n\t\tconst collector = remap(JSON.parse(file.contents.toString('utf8')), opts);\n\n\t\tlet sources;\n\t\tif (Object.keys(opts.sources.map).length) {\n\t\t\tsources = opts.sources;\n\t\t}\n\n\t\tconst p = [];\n\t\tif (opts.reports) {\n\t\t\tObject.keys(opts.reports).forEach((key) => {\n\t\t\t\tp.push(writeReport(collector, key, opts.reportOpts || {}, opts.reports[key], sources));\n\t\t\t});\n\t\t}\n\n\t\tfile.contents = new Buffer(JSON.stringify(collector.getFinalCoverage()));\n\n\t\tPromise.all(p).then(() => {\n\t\t\tcb(null, file);\n\t\t});\n\t});\n};\n"]}