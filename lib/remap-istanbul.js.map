{"version":3,"sources":["../src/remap-istanbul.js"],"names":["loadCoverage","require","remap","writeReport","MemoryStore","Collector","readStdIn","resolve","reject","stdin","process","buffer","setEncoding","on","data","e","resume","main","argv","getArg","arg","shift","indexOf","split","length","unshift","slice","join","substring","map","ch","concat","inputFiles","output","reportType","basePath","exclude","push","RegExp","replace","SyntaxError","coverage","then","JSON","parse","collector","add","getFinalCoverage","err","console","error","stack","sources","undefined","reportOptions","stdout","write","module","parent","title","code","exit","log","exports"],"mappings":";;;;;;;;;;;;;;;;AAEA,IAAMA,eAAeC,QAAQ,gBAAR,CAArB;AACA,IAAMC,QAAQD,QAAQ,SAAR,CAAd;AACA,IAAME,cAAcF,QAAQ,eAAR,CAApB;AACA,IAAMG,cAAcH,QAAQ,2BAAR,CAApB;AACA,IAAMI,YAAYJ,QAAQ,wBAAR,CAAlB;;AAEA;;;;;;AAMA,SAASK,SAAT,GAAqB;AACpB;AACA,QAAO,sBAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACvC,MAAMC,QAAQC,QAAQD,KAAtB;AACA,MAAIE,SAAS,EAAb;;AAEAF,QAAMG,WAAN,CAAkB,MAAlB;;AAEAH,QAAMI,EAAN,CAAS,MAAT,EAAiB,UAACC,IAAD,EAAU;AAC1BH,aAAUG,IAAV;AACA,GAFD;;AAIAL,QAAMI,EAAN,CAAS,OAAT,EAAkB,UAACE,CAAD,EAAO;AACxBP,UAAOO,CAAP;AACA,GAFD;;AAIAN,QAAMI,EAAN,CAAS,KAAT,EAAgB,YAAM;AACrBN,WAAQI,MAAR;AACA,GAFD;;AAIA,MAAI;AACHF,SAAMO,MAAN;AACA,GAFD,CAEE,OAAOD,CAAP,EAAU;AACXP,UAAOO,CAAP;AACA;AACD,EAvBM,CAAP;AAwBA;;AAED;;;;;;AAMA,SAASE,IAAT,CAAcC,IAAd,EAAoB;AACnB;;AAEA;;;;AAIA,UAASC,MAAT,GAAkB;AACjB,MAAIC,MAAMF,KAAKG,KAAL,EAAV;AACA,MAAID,OAAOA,IAAIE,OAAJ,CAAY,IAAZ,MAAsB,CAAjC,EAAoC;AACnCF,SAAMA,IAAIG,KAAJ,CAAU,GAAV,CAAN;AACA,OAAIH,IAAII,MAAJ,GAAa,CAAjB,EAAoB;AACnBN,SAAKO,OAAL,CAAaL,IAAIM,KAAJ,CAAU,CAAV,EAAaC,IAAb,CAAkB,GAAlB,CAAb;AACA;AACDP,SAAMA,IAAI,CAAJ,CAAN;AACA,GAND,MAMO,IAAIA,OAAOA,IAAI,CAAJ,MAAW,GAAtB,EAA2B;AACjC;AACA,OAAIA,IAAII,MAAJ,GAAa,CAAjB,EAAoB;AACnBN,WAAOE,IAAIQ,SAAJ,CAAc,CAAd,EAAiBL,KAAjB,CAAuB,EAAvB,EACLM,GADK,CACD,UAACC,EAAD;AAAA,YAAQ,MAAMA,EAAd;AAAA,KADC,EAELC,MAFK,CAEEb,IAFF,CAAP;AAGAE,UAAMF,KAAKG,KAAL,EAAN;AACA;AACD;;AAED,SAAOD,GAAP;AACA;;AAED,KAAIA,YAAJ;AACA,KAAMY,aAAa,EAAnB;AACA,KAAIC,eAAJ;AACA,KAAIC,mBAAJ;AACA,KAAIC,iBAAJ;AACA,KAAIC,gBAAJ;AACA,MAAKhB,MAAMD,QAAX,EAAqBC,GAArB,EAA0BA,MAAMD,QAAhC,EAA0C;AACzC,UAAQC,GAAR;AACC,QAAK,IAAL;AACA,QAAK,SAAL;AACCY,eAAWK,IAAX,CAAgBnB,KAAKG,KAAL,EAAhB;AACA;AACD,QAAK,IAAL;AACA,QAAK,UAAL;AACCY,aAASf,KAAKG,KAAL,EAAT;AACA;AACD,QAAK,IAAL;AACA,QAAK,YAAL;AACCc,eAAWjB,KAAKG,KAAL,EAAX;AACA;AACD,QAAK,IAAL;AACA,QAAK,QAAL;AACCa,iBAAahB,KAAKG,KAAL,EAAb;AACA;AACD,QAAK,IAAL;AACA,QAAK,WAAL;AACCe,cAAUlB,KAAKG,KAAL,EAAV;AACA,QAAIe,QAAQd,OAAR,CAAgB,GAAhB,MAAyB,CAAC,CAA9B,EAAiC;AAChCc,eAAU,IAAIE,MAAJ,CAAWF,QAAQG,OAAR,CAAgB,IAAhB,EAAsB,GAAtB,CAAX,CAAV;AACA;AACD;AACD;AACC,UAAM,IAAIC,WAAJ,8BAA2CpB,GAA3C,QAAN;AAzBF;AA2BA;;AAED,QAAO,sBAAY,UAACb,OAAD,EAAUC,MAAV,EAAqB;AACvC,MAAMiC,WAAWT,WAAWR,MAAX,GAAoBxB,aAAagC,UAAb,CAApB;AAChB;AACA1B,cAAYoC,IAAZ,CAAiB,UAAC5B,IAAD,EAAU;AAC1B,OAAI;AACHA,WAAO6B,KAAKC,KAAL,CAAW9B,IAAX,CAAP;AACA,QAAM+B,YAAY,IAAIxC,SAAJ,EAAlB;AACAwC,cAAUC,GAAV,CAAchC,IAAd;AACA,WAAO+B,UAAUE,gBAAV,EAAP;AACA,IALD,CAKE,OAAOC,GAAP,EAAY;AACbC,YAAQC,KAAR,CAAcF,IAAIG,KAAlB;AACA,UAAMH,GAAN;AACA;AACD,GAVD,EAUGxC,MAVH,CAFD;;AAcAD,UAAQkC,QAAR;AACA,EAhBM,EAgBJC,IAhBI,CAgBC,UAACD,QAAD,EAAc;AACrB,MAAIW,UAAU,IAAIhD,WAAJ,EAAd;AACA,MAAMyC,YAAY3C,MAAMuC,QAAN,EAAgB;AACjCW,mBADiC;AAEjCjB,aAAUA,YAAYkB,SAFW;AAGjCjB,YAASA,WAAWiB;AAHa,GAAhB,CAAlB;AAKA,MAAI,CAAC,oBAAYD,QAAQvB,GAApB,EAAyBL,MAA9B,EAAsC;AACrC4B,aAAUC,SAAV;AACA;AACD,MAAMC,gBAAgB,EAAtB;AACA,MAAIrB,MAAJ,EAAY;AACX,UAAO9B,YAAY0C,SAAZ,EAAuBX,cAAc,MAArC,EAA6CoB,aAA7C,EAA4DrB,MAA5D,EAAoEmB,OAApE,CAAP;AACA;AACD,MAAIlB,eAAeA,eAAe,UAAf,IAA6BA,eAAe,WAA3D,CAAJ,EAA6E;AAC5E,UAAO/B,YAAY0C,SAAZ,EAAuB,WAAvB,EAAoCS,aAApC,CAAP;AACA;AACD5C,UAAQ6C,MAAR,CAAeC,KAAf,CAAqB,yBAAeX,UAAUE,gBAAV,EAAf,IAA+C,IAApE;AACA,SAAO,IAAP;AACA,EAnCM,CAAP;AAoCA;;AAED;AACA,IAAI,CAACU,OAAOC,MAAZ,EAAoB;AACnBhD,SAAQiD,KAAR,GAAgB,gBAAhB;AACA;AACA1C,MAAKP,QAAQQ,IAAR,CAAaQ,KAAb,CAAmB,CAAnB,CAAL,EACEgB,IADF,CAEE,UAACkB,IAAD;AAAA,SAAUlD,QAAQmD,IAAR,CAAaD,QAAQ,CAArB,CAAV;AAAA,EAFF,EAGE,UAACZ,GAAD,EAAS;AACRC,UAAQa,GAAR,CAAYd,IAAIG,KAAhB;AACAzC,UAAQmD,IAAR,CAAa,CAAb;AACA,EANH;AAOA,CAVD,MAUO;AACNJ,QAAOM,OAAP,GAAiB9C,IAAjB;AACA","file":"remap-istanbul.js","sourcesContent":["\n\nconst loadCoverage = require('./loadCoverage');\nconst remap = require('./remap');\nconst writeReport = require('./writeReport');\nconst MemoryStore = require('istanbul/lib/store/memory');\nconst Collector = require('istanbul/lib/collector');\n\n/**\n * Helper function that reads from standard in and resolves a Promise with the\n * data or rejects with any errors.\n * @return {Promise} A promsie that is resolved with the data from standard in\n *                   or rejected with any errors.\n */\nfunction readStdIn() {\n\t/* istanbul ignore next: too challenging to test for reading from stdin */\n\treturn new Promise((resolve, reject) => {\n\t\tconst stdin = process.stdin;\n\t\tlet buffer = '';\n\n\t\tstdin.setEncoding('utf8');\n\n\t\tstdin.on('data', (data) => {\n\t\t\tbuffer += data;\n\t\t});\n\n\t\tstdin.on('error', (e) => {\n\t\t\treject(e);\n\t\t});\n\n\t\tstdin.on('end', () => {\n\t\t\tresolve(buffer);\n\t\t});\n\n\t\ttry {\n\t\t\tstdin.resume();\n\t\t} catch (e) {\n\t\t\treject(e);\n\t\t}\n\t});\n}\n\n/**\n * The main wrapper to provide a CLI interface to remap-istanbul\n * @param  {Array}   argv An array of arguments passed the process\n * @return {Promise}      A promise that resolves when the remapping is complete\n *                        or rejects if there is an error.\n */\nfunction main(argv) {\n\t/* jshint maxcomplexity:13 */\n\n\t/**\n\t * Helper function that processes the arguments\n\t * @return {String} The next valid argument\n\t */\n\tfunction getArg() {\n\t\tlet arg = argv.shift();\n\t\tif (arg && arg.indexOf('--') === 0) {\n\t\t\targ = arg.split('=');\n\t\t\tif (arg.length > 1) {\n\t\t\t\targv.unshift(arg.slice(1).join('='));\n\t\t\t}\n\t\t\targ = arg[0];\n\t\t} else if (arg && arg[0] === '-') {\n\t\t\t/* istanbul ignore if */\n\t\t\tif (arg.length > 2) {\n\t\t\t\targv = arg.substring(1).split('')\n\t\t\t\t\t.map((ch) => '-' + ch)\n\t\t\t\t\t.concat(argv);\n\t\t\t\targ = argv.shift();\n\t\t\t}\n\t\t}\n\n\t\treturn arg;\n\t}\n\n\tlet arg;\n\tconst inputFiles = [];\n\tlet output;\n\tlet reportType;\n\tlet basePath;\n\tlet exclude;\n\tfor (arg = getArg(); arg; arg = getArg()) {\n\t\tswitch (arg) {\n\t\t\tcase '-i':\n\t\t\tcase '--input':\n\t\t\t\tinputFiles.push(argv.shift());\n\t\t\t\tbreak;\n\t\t\tcase '-o':\n\t\t\tcase '--output':\n\t\t\t\toutput = argv.shift();\n\t\t\t\tbreak;\n\t\t\tcase '-b':\n\t\t\tcase '--basePath':\n\t\t\t\tbasePath = argv.shift();\n\t\t\t\tbreak;\n\t\t\tcase '-t':\n\t\t\tcase '--type':\n\t\t\t\treportType = argv.shift();\n\t\t\t\tbreak;\n\t\t\tcase '-e':\n\t\t\tcase '--exclude':\n\t\t\t\texclude = argv.shift();\n\t\t\t\tif (exclude.indexOf(',') !== -1) {\n\t\t\t\t\texclude = new RegExp(exclude.replace(/,/g, '|'));\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tthrow new SyntaxError(`Unrecognised argument: \"${arg}\".`);\n\t\t}\n\t}\n\n\treturn new Promise((resolve, reject) => {\n\t\tconst coverage = inputFiles.length ? loadCoverage(inputFiles) :\n\t\t\t/* istanbul ignore next */\n\t\t\treadStdIn().then((data) => {\n\t\t\t\ttry {\n\t\t\t\t\tdata = JSON.parse(data);\n\t\t\t\t\tconst collector = new Collector();\n\t\t\t\t\tcollector.add(data);\n\t\t\t\t\treturn collector.getFinalCoverage();\n\t\t\t\t} catch (err) {\n\t\t\t\t\tconsole.error(err.stack);\n\t\t\t\t\tthrow err;\n\t\t\t\t}\n\t\t\t}, reject);\n\n\t\tresolve(coverage);\n\t}).then((coverage) => {\n\t\tlet sources = new MemoryStore();\n\t\tconst collector = remap(coverage, {\n\t\t\tsources,\n\t\t\tbasePath: basePath || undefined,\n\t\t\texclude: exclude || undefined,\n\t\t});\n\t\tif (!Object.keys(sources.map).length) {\n\t\t\tsources = undefined;\n\t\t}\n\t\tconst reportOptions = {};\n\t\tif (output) {\n\t\t\treturn writeReport(collector, reportType || 'json', reportOptions, output, sources);\n\t\t}\n\t\tif (reportType && (reportType === 'lcovonly' || reportType === 'text-lcov')) {\n\t\t\treturn writeReport(collector, 'text-lcov', reportOptions);\n\t\t}\n\t\tprocess.stdout.write(JSON.stringify(collector.getFinalCoverage()) + '\\n');\n\t\treturn null;\n\t});\n}\n\n/* istanbul ignore if: we use the module interface in testing */\nif (!module.parent) {\n\tprocess.title = 'remap-istanbul';\n\t/* first two arguments are meaningless to the process */\n\tmain(process.argv.slice(2))\n\t\t.then(\n\t\t\t(code) => process.exit(code || 0),\n\t\t\t(err) => {\n\t\t\t\tconsole.log(err.stack);\n\t\t\t\tprocess.exit(1);\n\t\t\t});\n} else {\n\tmodule.exports = main;\n}\n"]}